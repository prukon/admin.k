<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Документация: отчёт “Платежи” (админка)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height: 1.5; color: #111; margin: 0; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 26px; margin: 0 0 8px; }
    h2 { font-size: 18px; margin-top: 28px; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    code { background: #f4f4f5; padding: 1px 5px; border-radius: 4px; }
    .note { background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px; }
    ul { margin: 8px 0 8px 20px; }
    .small { color: #555; font-size: 13px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Отчёт “Платежи” (админка)</h1>
  <div class="small">Файл: <code>/docs/documentation/reports-payments.html</code></div>

  <h2>1) Где находится</h2>
  <ul>
    <li>Страница: <code>/admin/reports/payments</code></li>
  </ul>

  <h2>2) Поля списка (управление видимостью колонок)</h2>
  <div class="note">
    На странице отчёта доступна кнопка <b>“Поля списка”</b> (иконка колонок).
    Можно включать/выключать отображение колонок таблицы (включая “Действия”).
    Настройка сохраняется <b>для текущего пользователя</b>.
  </div>
  <ul>
    <li><b>Где хранится</b>: таблица <code>user_table_settings</code></li>
    <li><b>Ключ таблицы</b>: <code>table_key = reports_payments</code></li>
    <li><b>API</b>:
      <ul>
        <li><code>GET /admin/reports/payments/columns-settings</code> — получить настройки</li>
        <li><code>POST /admin/reports/payments/columns-settings</code> — сохранить настройки (<code>columns: {key: true/false}</code>)</li>
      </ul>
    </li>
  </ul>

  <h2>3) Колонки: выплаты и комиссии (T‑Bank)</h2>
  <div class="note">
    Эти колонки заполняются <b>только для платежей через T‑Bank</b>.
    Для других провайдеров значения будут пустыми.
  </div>
  <div class="note">
    <b>Источник расчёта комиссий:</b> правила из таблицы <code>tinkoff_commission_rules</code>.
    Комиссии удерживаются с партнёра. Округление: математическое (<code>round</code>) до копейки.
    Формула:
    <pre>bank_acquiring_fee = max(round(gross * acquiring_percent/100), acquiring_min_fixed)
bank_payout_fee    = max(round(gross * payout_percent/100),    payout_min_fixed)
platform_fee       = max(round(gross * platform_percent/100),  platform_min_fixed)

commission_total = bank_acquiring_fee + bank_payout_fee + platform_fee
net_to_partner   = gross - commission_total</pre>
  </div>
  <ul>
    <li><b>Выплата</b> (<code>payout_amount</code>):
      фактическая сумма выплаты партнёру.
      Заполняется <b>только после успешного зачисления</b> (статус выплаты <code>COMPLETED</code> в <code>tinkoff_payouts</code>).
      Если выплаты не было — поле пустое.</li>
    <li><b>К выплате</b> (<code>net_to_partner</code>):
      расчётная сумма к выплате партнёру (нетто).
      Заполняется <b>сразу</b> после оплаты по формуле: сумма − (комиссии банка + комиссия платформы).</li>
    <li><b>Комиссия</b> (<code>commission_total</code>):
      суммарные удержания по тарифу и комиссии банка (без детализации), заполняется <b>всегда</b>.
      <br>В <b>hover</b>: “Суммарные удержания по тарифу и комиссии банка”.</li>
    <li><b>Комиссия банка</b> (<code>bank_commission_total</code>):
      сумма <b>комиссии за эквайринг</b> + <b>комиссии за выплату</b>.
      Заполняется <b>всегда</b> (даже если выплаты ещё не было), рассчитывается по правилам <code>tinkoff_commission_rules</code>.
      <br>В <b>hover</b> показывается расшифровка: “Эквайринг” и “Выплата”.</li>
    <li><b>Комиссия платформы</b> (<code>platform_commission</code>):
      комиссия платформы, заполняется <b>всегда</b>, рассчитывается по правилам <code>tinkoff_commission_rules</code>.</li>
  </ul>

  <div class="note">
    <b>Права доступа:</b> детальные колонки комиссий (<code>bank_commission_total</code>, <code>platform_commission</code>)
    показываются только пользователям с правом <code>reports.additional-value.view</code>.
    Для остальных пользователей детальные колонки скрыты. “К выплате” (<code>net_to_partner</code>) и “Комиссия” (<code>commission_total</code>) доступны всем.
  </div>

  <div class="note">
    <b>Порядок колонок (после “Провайдер”):</b>
    “Комиссия банка” → “Комиссия платформы” → “Комиссия” → “К выплате” → “Выплата”.
  </div>

  <h2>4) Колонки: возвраты</h2>
  <div class="note">
    В таблице есть 2 колонки, связанные с возвратами:
    <ul>
      <li><b>Действия</b> (<code>refund_action</code>) — кнопка “Возврат” (может быть недоступна, если возврат запрещён правилами).</li>
      <li><b>Статус возврата</b> (<code>refund_status</code>) — текущий статус возврата (например, <code>pending</code>/<code>succeeded</code>/<code>failed</code>).</li>
    </ul>
    Порядок этих колонок в таблице: <b>“Действия”</b>, затем <b>“Статус возврата”</b>.
  </div>
</div>
</body>
</html>

